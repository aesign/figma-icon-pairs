var se=Object.defineProperty;var D=Object.getOwnPropertySymbols;var ie=Object.prototype.hasOwnProperty,oe=Object.prototype.propertyIsEnumerable;var j=(e,t,r)=>t in e?se(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,H=(e,t)=>{for(var r in t||(t={}))ie.call(t,r)&&j(e,r,t[r]);if(D)for(var r of D(t))oe.call(t,r)&&j(e,r,t[r]);return e};var ae=Object.defineProperty,ce=(e,t,r)=>t in e?ae(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,y=(e,t,r)=>(ce(e,typeof t!="symbol"?t+"":t,r),r),S=(e,t,r)=>new Promise((n,s)=>{var i=l=>{try{o(r.next(l))}catch(d){s(d)}},a=l=>{try{o(r.throw(l))}catch(d){s(d)}},o=l=>l.done?n(l.value):Promise.resolve(l.value).then(i,a);o((r=r.apply(e,t)).next())});class le extends Error{constructor(t){super(t.payload[0])}}function E(){const e=new Array(36);for(let t=0;t<36;t++)e[t]=Math.floor(Math.random()*16);return e[14]=4,e[19]=e[19]&=-5,e[19]=e[19]|=8,e[8]=e[13]=e[18]=e[23]="-",e.map(t=>t.toString(16)).join("")}const B="__INTERNAL_SUCCESS_RESPONSE_EVENT",O="__INTERNAL_ERROR_RESPONSE_EVENT";class ue{constructor(t){y(this,"emitStrategies",new Map),y(this,"receiveStrategies",new Map),this.side=t}receivesFrom(t,r){return this.receiveStrategies.set(t.name,r),this}emitsTo(t,r){return this.emitStrategies.set(t.name,r),this}startListening(){return new de(this.side,this.emitStrategies,this.receiveStrategies)}}class de{constructor(t,r=new Map,n=new Map){y(this,"messageHandlers",{}),y(this,"subscriptionListeners",{}),y(this,"pendingRequests",new Map),y(this,"cleanupCallbacks",[]),this.side=t,this.emitStrategies=r,this.receiveStrategies=n,n.forEach(s=>{const i=s((a,o)=>this.receiveNetworkMessage(a,o));i&&this.cleanupCallbacks.push(i)})}registerMessageHandler(t,r){this.messageHandlers[t]=r}getEmitStrategy(t){const r=this.emitStrategies.get(t.name);if(!r){const n=g.getCurrentSide();throw new Error(`No emit strategy is registered from ${n.name} to ${t.name}`)}return r}receiveNetworkMessage(t,r){return S(this,null,function*(){if(t.eventName===B){this.receiveSuccessResponse(t);return}if(t.eventName===O){this.receiveErrorResponse(t);return}this.invokeSubscribers(t),this.handleIncomingMessage(t,r)})}receiveSuccessResponse(t){return S(this,null,function*(){var r;const{resolve:n}=(r=this.pendingRequests.get(t.messageId))!=null?r:{};n&&(this.pendingRequests.delete(t.messageId),n(t.payload[0]))})}receiveErrorResponse(t){return S(this,null,function*(){var r;const{reject:n}=(r=this.pendingRequests.get(t.messageId))!=null?r:{};n&&(this.pendingRequests.delete(t.messageId),n(new le(t)))})}invokeSubscribers(t){return S(this,null,function*(){var r;Object.values((r=this.subscriptionListeners[t.eventName])!=null?r:{}).forEach(n=>{n(...t.payload,g.getSide(t.fromSide),t)})})}handleIncomingMessage(t,r){return S(this,null,function*(){const n=this.messageHandlers[t.eventName];if(n!=null){const s=g.getSide(t.fromSide);if(!s)throw new Error(`Message received from an unknown side: ${t.fromSide}`);const i=this.getEmitStrategy(s);try{const a=yield n(...t.payload,g.getSide(t.fromSide),t);i!=null&&i({messageId:t.messageId,fromSide:t.fromSide,eventName:B,payload:[a]},r)}catch(a){i!=null&&i({messageId:t.messageId,fromSide:t.fromSide,eventName:O,payload:[a instanceof Error?a.message:"Failed to handle"]},r)}}})}emit(t,r,n,...[s]){this.getEmitStrategy(t)({messageId:E(),fromSide:g.getCurrentSide().name,eventName:r.toString(),payload:n},s)}request(t,r,n){return S(this,arguments,function*(s,i,a,...[o]){const l=this.getEmitStrategy(s),d=E();return new Promise((f,c)=>{this.pendingRequests.set(d,{resolve:f,reject:c}),l({messageId:d,fromSide:g.getCurrentSide().name,eventName:i.toString(),payload:a},o)})})}subscribe(t,r){var n,s;const i=E(),a=(s=(n=this.subscriptionListeners)[t])!=null?s:n[t]={};return a[i]=r,()=>{delete this.subscriptionListeners[t][i]}}}class fe{constructor(t){this.name=t}channelBuilder(){return new ue(this)}}var g;(e=>{const t=[];let r;function n(){if(r==null)throw new Error("Logical side is not initialized yet.");return r}e.getCurrentSide=n;function s(o,l){if(r!=null)throw new Error("Logical side can be declared only once.");if(l.side!==o)throw new Error("Given side and channel side doesn't match");r=o}e.initialize=s;function i(o){return{listens:()=>{const l=new fe(o);return t.push(l),l}}}e.createSide=i;function a(o){for(let l of t)if(l.name===o)return l;return null}e.getSide=a})(g||(g={}));const U=g.createSide("UI-side").listens(),$=g.createSide("Plugin-side").listens(),k=["SFS","SFG","SFC","SFT","MS","MSC","MST"];function v(e){return e.filter(Boolean).join(", ")}function w(e){return e.trim()?e.split(",").map(t=>t.trim()).filter(Boolean):[]}function z(e,t){const r={SFS:e.name,SFG:e.symbol,SFC:v(e.categories),SFT:v(e.searchTerms),MS:t.name,MSC:v(t.categories),MST:v(t.tags)};return k.map(n=>{var s;return`${n}: ${(s=r[n])!=null?s:""}`}).join(`
`)}function T(e){var n;const t=e.split(/\r?\n/),r={SFS:"",SFG:"",SFC:"",SFT:"",MS:"",MSC:"",MST:""};for(const s of t){const i=s.match(/^([A-Z]{2,3}):\s*(.*)$/);if(!i)continue;const a=i[1];k.includes(a)&&(r[a]=(n=i[2])!=null?n:"")}return!r.SFS&&!r.MS?null:{sfName:r.SFS,sfGlyph:r.SFG,sfCategories:w(r.SFC),sfSearchTerms:w(r.SFT),materialName:r.MS,materialCategories:w(r.MSC),materialTags:w(r.MST)}}const q="variableGroupId",K="mappingState",X="ipairs",u=(...e)=>{try{console.log("[icon-pairs][plugin]",...e)}catch(t){}},m=$.channelBuilder().emitsTo(U,e=>{figma.ui.postMessage(e)}).receivesFrom(U,e=>{const t=r=>e(r);return figma.ui.on("message",t),()=>figma.ui.off("message",t)}).startListening();function me(e){var n,s,i,a,o,l,d,f;if(typeof e=="string")return{id:e,name:e};if(!e)return null;const t=(a=(i=(s=(n=e.id)!=null?n:e.groupId)!=null?s:e.key)!=null?i:e.modeId)!=null?a:typeof e.name=="string"?e.name:null,r=(f=(d=(l=(o=e.name)!=null?o:e.label)!=null?l:e.title)!=null?d:e.groupName)!=null?f:typeof e.id=="string"?e.id:null;return t?{id:String(t),name:String(r!=null?r:t)}:null}async function ge(){const e=await figma.variables.getLocalVariableCollectionsAsync(),t=await figma.variables.getLocalVariablesAsync("STRING");return e.map(r=>{var l,d,f;const n=t.filter(c=>c.variableCollectionId===r.id),s=(f=(d=(l=r.variableGroups)!=null?l:r.groups)!=null?d:r.variableGroupIds)!=null?f:[],i=Array.isArray(s)?s.map(me).filter(c=>!!c):[],a=new Map;for(const c of n){const p=(c.name||"").split("/").filter(Boolean);for(let h=1;h<p.length;h++){const M=p.slice(0,h).join("/");a.has(M)||a.set(M,{id:M,name:M})}}const o=new Map;for(const c of i)o.set(c.id,c);for(const c of a.values())o.set(c.id,c);return{id:r.id,name:r.name,modes:r.modes.map(c=>({modeId:c.modeId,name:c.name})),defaultModeId:r.defaultModeId,groups:Array.from(o.values())}})}function N(e,t,r){const n=e.modes.map(o=>o.modeId),s=new Set(t),i=new Set(r);if(s.size===0||i.size===0)throw new Error("Assign at least one mode to SF and one to Material.");for(const o of s){if(!n.includes(o))throw new Error("Some SF modes are not part of the collection.");if(i.has(o))throw new Error("A mode cannot be assigned to both SF and Material.")}for(const o of i)if(!n.includes(o))throw new Error("Some Material modes are not part of the collection.");if(new Set([...s,...i]).size!==n.length)throw new Error("Every mode in the collection must be assigned to SF or Material.")}function A(e){var n,s;const t=(n=e.variableGroupId)!=null?n:null;return((s=e.getPluginData)==null?void 0:s.call(e,q))||t||null}function Y(e,t){var n,s;if(!t)return;const r=(s=(n=e.setVariableGroupId)!=null?n:e.setGroupId)!=null?s:e.assignVariableGroup;if(typeof r=="function")try{r.call(e,t)}catch(i){console.warn("Unable to set variable group via setter",i)}else if("variableGroupId"in e)try{e.variableGroupId=t}catch(i){console.warn("Unable to assign variableGroupId directly",i)}try{e.setPluginData(q,t)}catch(i){console.warn("Unable to store group id in plugin data",i)}}function he(e,t){if(!e||!t)return!1;const r=e.split("/").filter(Boolean);for(let n=1;n<r.length;n++)if(r.slice(0,n).join("/")===t)return!0;return!1}function C(e,t,r){var l,d,f;const n=(l=e.valuesByMode)!=null?l:{},s=t[0],i=r[0],a=s&&typeof n[s]=="string"?n[s]:null,o=i&&typeof n[i]=="string"?n[i]:null;return{id:e.id,name:e.name,collectionId:e.variableCollectionId,groupId:A(e),description:(d=e.description)!=null?d:"",descriptionFields:T((f=e.description)!=null?f:""),sfValue:a,materialValue:o}}function V(){try{const e=figma.root.getPluginData(X);if(!e)return new Map;const t=JSON.parse(e);if(!t||!Array.isArray(t.p))return new Map;const r=new Map;for(const n of t.p)Array.isArray(n)&&typeof n[0]=="string"&&typeof n[1]=="string"&&typeof n[2]=="string"&&typeof n[3]=="number"&&typeof n[4]=="number"&&r.set(n[0],{id:n[0],sf:n[1],mat:n[2],c:n[3],u:n[4]});return r}catch(e){return console.warn("Failed to parse pluginData pairs",e),new Map}}function W(e){if(!e||typeof e!="object")return"";for(const t of Object.values(e))if(typeof t=="string"&&t)return t;return""}function G(e,t){const r={v:1,p:e.map(n=>[n.id,n.sf,n.mat,n.c,n.u])};try{figma.root.setPluginData(X,JSON.stringify(r)),u("pluginData updated",{reason:t,count:e.length,payload:r})}catch(n){console.warn("Unable to store pluginData pairs",n)}}async function Se(){const e=V(),t=Date.now(),n=(await figma.variables.getLocalVariablesAsync("STRING")).map(s=>{var d,f;const i=T((d=s.description)!=null?d:"")||null,a=(i==null?void 0:i.sfName)||s.name||"",o=(i==null?void 0:i.materialName)||W(s.valuesByMode)||"",l=e.get(s.id);return{id:s.id,sf:a,mat:o,c:(f=l==null?void 0:l.c)!=null?f:t,u:t}});G(n,"snapshot")}async function J(e){var o,l;const t=V(),r=Date.now(),n=T((o=e.description)!=null?o:"")||null,s=(n==null?void 0:n.sfName)||e.name||"",i=(n==null?void 0:n.materialName)||W(e.valuesByMode)||"",a=t.get(e.id);t.set(e.id,{id:e.id,sf:s,mat:i,c:(l=a==null?void 0:a.c)!=null?l:r,u:r}),G(Array.from(t.values()),"upsert")}async function Ie(e){const t=V();t.delete(e),G(Array.from(t.values()),"remove")}async function F(e){const t=await figma.variables.getVariableCollectionByIdAsync(e);if(!t)throw new Error("Collection not found.");return t}m.registerMessageHandler("ping",()=>(u("ping"),"pong"));m.registerMessageHandler("getEnvironment",async()=>{const e=figma.editorType==="dev"||figma.mode==="dev"||figma.mode==="code"||figma.isInDevMode===!0||figma.devMode===!0,r=(await figma.variables.getLocalVariableCollectionsAsync()).length>0;return u("getEnvironment",{editorType:figma.editorType,isDevMode:e}),{isDevMode:e,isLibraryFile:r}});function I(e){if(u("extractIds:raw",e),!e)return[];if(typeof e=="string")return e.startsWith("VariableID:")||e.startsWith("VariableCollectionId:")?[e]:(u("extractIds:string_ignored",e),[]);if(Array.isArray(e)){const t=e.flatMap(r=>I(r));return u("extractIds:array",t),t}if(typeof e=="object"&&e!==null){if(typeof e.id=="string")return u("extractIds:object.id",e.id),[e.id];if(typeof e.variableId=="string")return u("extractIds:object.variableId",e.variableId),[e.variableId];if(typeof e.value=="string")return u("extractIds:object.value",e.value),[e.value];u("extractIds:object.unhandledKeys",Object.keys(e))}return[]}function Z(){const e=new Set,t=r=>{var n,s,i,a;if(u("visit:node",{type:r.type,name:r.name}),"children"in r)for(const o of r.children)t(o);if(r.type==="TEXT"){const o=r.boundVariables;u("text",r),u("text:boundVariables",o);const l=o==null?void 0:o.characters,d=I(l);u("text:charactersVarIds",d),d.forEach(f=>e.add(f))}if("componentProperties"in r){u("instanceNode",r);const o=(n=r.componentProperties)!=null?n:{},l=(i=(s=r.boundVariables)==null?void 0:s.componentProperties)!=null?i:{},d=(a=r.componentPropertyReferences)!=null?a:{};Object.entries(o).forEach(([f,c])=>{var R,_,L;const b=l[f],p=d[f],h=(L=(_=(R=c==null?void 0:c.boundVariables)==null?void 0:R.value)!=null?_:c==null?void 0:c.boundVariables)!=null?L:void 0;if(u("instance:componentProperty",{node:r.name,name:f,type:c==null?void 0:c.type,value:c==null?void 0:c.value,bound:b,ref:p,inlineBound:h}),(c==null?void 0:c.type)==="TEXT"||(c==null?void 0:c.type)==="STRING"||(c==null?void 0:c.type)==="TEXT_LITERAL"){const Q=I(b),ee=I(c==null?void 0:c.value),te=I(p),re=I(h),x=[...Q,...ee,...te,...re];u("instance:componentPropertyVarIds",{name:f,ids:x}),x.forEach(ne=>e.add(ne))}})}};for(const r of figma.currentPage.selection)t(r);return{pairIds:Array.from(e),selectionCount:figma.currentPage.selection.length}}function P(){const e=Z();u("selectionchange",`nodes=${e.selectionCount}`,`pairIds=${e.pairIds.join(",")||"none"}`);try{figma.ui.postMessage(H({type:"selectionPairs"},e))}catch(t){console.warn("Failed to post selection pairs",t)}}function ye(){figma.on("selectionchange",P),P()}m.registerMessageHandler("getSelectionPairs",async()=>Z());m.registerMessageHandler("clearSelection",async()=>{figma.currentPage.selection=[],P()});m.registerMessageHandler("notify",async e=>{u("notify",e);try{figma.notify(e,{timeout:2e3})}catch(t){console.warn("Failed to notify",t)}});m.registerMessageHandler("getCollections",async()=>(u("getCollections"),ge()));m.registerMessageHandler("loadMappingState",async()=>{var n,s,i,a;u("loadMappingState");const e=await figma.clientStorage.getAsync(K);if(!e)return{collectionId:null,groupId:null,sfModeIds:[],materialModeIds:[]};const t=e,r=o=>Array.isArray(o)?o.filter(l=>typeof l=="string"):typeof o=="string"?o?[o]:[]:[];return{collectionId:(n=t.collectionId)!=null?n:null,groupId:(s=t.groupId)!=null?s:null,sfModeIds:r((i=t.sfModeIds)!=null?i:t.sfModeId),materialModeIds:r((a=t.materialModeIds)!=null?a:t.materialModeId)}});m.registerMessageHandler("saveMappingState",async e=>{u("saveMappingState",e),await figma.clientStorage.setAsync(K,e)});m.registerMessageHandler("loadPairs",async e=>{u("loadPairs",e);const t=await F(e.collectionId);return N(t,e.sfModeIds,e.materialModeIds),(await figma.variables.getLocalVariablesAsync("STRING")).filter(s=>s.variableCollectionId!==e.collectionId?!1:e.groupId?A(s)===e.groupId?!0:he(s.name||"",e.groupId):!0).map(s=>C(s,e.sfModeIds,e.materialModeIds))});m.registerMessageHandler("createPair",async e=>{var n;if(u("createPair",e),figma.editorType!=="figma")throw new Error("Variables are only supported in Figma files.");const t=await F(e.collectionId);N(t,e.sfModeIds,e.materialModeIds);const r=figma.variables.createVariable(e.groupId?`${e.groupId}/${e.sf.symbol}`:e.sf.symbol,t,"STRING");return u("createPair variable created",r.id),Y(r,(n=e.groupId)!=null?n:null),r.scopes=["TEXT_CONTENT"],e.sfModeIds.forEach(s=>r.setValueForMode(s,e.sf.symbol)),e.materialModeIds.forEach(s=>r.setValueForMode(s,e.material.name)),r.description=z(e.sf,e.material),u("createPair variable configured",{id:r.id,name:r.name}),await J(r),C(r,e.sfModeIds,e.materialModeIds)});m.registerMessageHandler("updatePair",async e=>{var i,a;u("updatePair",e);const t=await figma.variables.getVariableByIdAsync(e.variableId);if(!t)throw new Error("Variable not found.");if(t.resolvedType!=="STRING")throw new Error("Only STRING variables can be updated.");if(t.variableCollectionId!==e.collectionId)throw new Error("Cannot move variable to a different collection.");const r=await F(e.collectionId);N(r,e.sfModeIds,e.materialModeIds);const n=A(t),s=(a=(i=e.groupId)!=null?i:n)!=null?a:null;if((s!=null?s:null)!==(n!=null?n:null))throw new Error("Group cannot be changed for an existing pair.");return Y(t,s),t.name=s?`${s}/${e.sf.symbol}`:e.sf.symbol,e.sfModeIds.forEach(o=>t.setValueForMode(o,e.sf.symbol)),e.materialModeIds.forEach(o=>t.setValueForMode(o,e.material.name)),t.description=z(e.sf,e.material),t.scopes=["TEXT_CONTENT"],await J(t),C(t,e.sfModeIds,e.materialModeIds)});m.registerMessageHandler("deletePair",async e=>{u("deletePair",{variableId:e});const t=await figma.variables.getVariableByIdAsync(e);t&&(t.remove(),await Ie(e))});async function pe(){g.initialize($,m),figma.showUI(__html__,{width:320,height:660,themeColors:!0}),ye(),Se().catch(e=>console.warn("Failed to snapshot plugin data",e)),console.log("Bootstrapped @",g.getCurrentSide().name)}pe();
