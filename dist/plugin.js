var ne=Object.defineProperty;var D=Object.getOwnPropertySymbols;var re=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable;var j=(e,t,n)=>t in e?ne(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,x=(e,t)=>{for(var n in t||(t={}))re.call(t,n)&&j(e,n,t[n]);if(D)for(var n of D(t))se.call(t,n)&&j(e,n,t[n]);return e};var ie=Object.defineProperty,ae=(e,t,n)=>t in e?ie(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,I=(e,t,n)=>(ae(e,typeof t!="symbol"?t+"":t,n),n),h=(e,t,n)=>new Promise((r,s)=>{var i=c=>{try{a(n.next(c))}catch(d){s(d)}},o=c=>{try{a(n.throw(c))}catch(d){s(d)}},a=c=>c.done?r(c.value):Promise.resolve(c.value).then(i,o);a((n=n.apply(e,t)).next())});class oe extends Error{constructor(t){super(t.payload[0])}}function p(){const e=new Array(36);for(let t=0;t<36;t++)e[t]=Math.floor(Math.random()*16);return e[14]=4,e[19]=e[19]&=-5,e[19]=e[19]|=8,e[8]=e[13]=e[18]=e[23]="-",e.map(t=>t.toString(16)).join("")}const H="__INTERNAL_SUCCESS_RESPONSE_EVENT",O="__INTERNAL_ERROR_RESPONSE_EVENT";class ce{constructor(t){I(this,"emitStrategies",new Map),I(this,"receiveStrategies",new Map),this.side=t}receivesFrom(t,n){return this.receiveStrategies.set(t.name,n),this}emitsTo(t,n){return this.emitStrategies.set(t.name,n),this}startListening(){return new le(this.side,this.emitStrategies,this.receiveStrategies)}}class le{constructor(t,n=new Map,r=new Map){I(this,"messageHandlers",{}),I(this,"subscriptionListeners",{}),I(this,"pendingRequests",new Map),I(this,"cleanupCallbacks",[]),this.side=t,this.emitStrategies=n,this.receiveStrategies=r,r.forEach(s=>{const i=s((o,a)=>this.receiveNetworkMessage(o,a));i&&this.cleanupCallbacks.push(i)})}registerMessageHandler(t,n){this.messageHandlers[t]=n}getEmitStrategy(t){const n=this.emitStrategies.get(t.name);if(!n){const r=g.getCurrentSide();throw new Error(`No emit strategy is registered from ${r.name} to ${t.name}`)}return n}receiveNetworkMessage(t,n){return h(this,null,function*(){if(t.eventName===H){this.receiveSuccessResponse(t);return}if(t.eventName===O){this.receiveErrorResponse(t);return}this.invokeSubscribers(t),this.handleIncomingMessage(t,n)})}receiveSuccessResponse(t){return h(this,null,function*(){var n;const{resolve:r}=(n=this.pendingRequests.get(t.messageId))!=null?n:{};r&&(this.pendingRequests.delete(t.messageId),r(t.payload[0]))})}receiveErrorResponse(t){return h(this,null,function*(){var n;const{reject:r}=(n=this.pendingRequests.get(t.messageId))!=null?n:{};r&&(this.pendingRequests.delete(t.messageId),r(new oe(t)))})}invokeSubscribers(t){return h(this,null,function*(){var n;Object.values((n=this.subscriptionListeners[t.eventName])!=null?n:{}).forEach(r=>{r(...t.payload,g.getSide(t.fromSide),t)})})}handleIncomingMessage(t,n){return h(this,null,function*(){const r=this.messageHandlers[t.eventName];if(r!=null){const s=g.getSide(t.fromSide);if(!s)throw new Error(`Message received from an unknown side: ${t.fromSide}`);const i=this.getEmitStrategy(s);try{const o=yield r(...t.payload,g.getSide(t.fromSide),t);i!=null&&i({messageId:t.messageId,fromSide:t.fromSide,eventName:H,payload:[o]},n)}catch(o){i!=null&&i({messageId:t.messageId,fromSide:t.fromSide,eventName:O,payload:[o instanceof Error?o.message:"Failed to handle"]},n)}}})}emit(t,n,r,...[s]){this.getEmitStrategy(t)({messageId:p(),fromSide:g.getCurrentSide().name,eventName:n.toString(),payload:r},s)}request(t,n,r){return h(this,arguments,function*(s,i,o,...[a]){const c=this.getEmitStrategy(s),d=p();return new Promise((f,u)=>{this.pendingRequests.set(d,{resolve:f,reject:u}),c({messageId:d,fromSide:g.getCurrentSide().name,eventName:i.toString(),payload:o},a)})})}subscribe(t,n){var r,s;const i=p(),o=(s=(r=this.subscriptionListeners)[t])!=null?s:r[t]={};return o[i]=n,()=>{delete this.subscriptionListeners[t][i]}}}class ue{constructor(t){this.name=t}channelBuilder(){return new ce(this)}}var g;(e=>{const t=[];let n;function r(){if(n==null)throw new Error("Logical side is not initialized yet.");return n}e.getCurrentSide=r;function s(a,c){if(n!=null)throw new Error("Logical side can be declared only once.");if(c.side!==a)throw new Error("Given side and channel side doesn't match");n=a}e.initialize=s;function i(a){return{listens:()=>{const c=new ue(a);return t.push(c),c}}}e.createSide=i;function o(a){for(let c of t)if(c.name===a)return c;return null}e.getSide=o})(g||(g={}));const U=g.createSide("UI-side").listens(),B=g.createSide("Plugin-side").listens(),k=["SFS","SFG","SFC","SFT","MS","MSC","MST"];function y(e){return e.filter(Boolean).join(", ")}function M(e){return e.trim()?e.split(",").map(t=>t.trim()).filter(Boolean):[]}function z(e,t){const n={SFS:e.name,SFG:e.symbol,SFC:y(e.categories),SFT:y(e.searchTerms),MS:t.name,MSC:y(t.categories),MST:y(t.tags)};return k.map(r=>{var s;return`${r}: ${(s=n[r])!=null?s:""}`}).join(`
`)}function w(e){var r;const t=e.split(/\r?\n/),n={SFS:"",SFG:"",SFC:"",SFT:"",MS:"",MSC:"",MST:""};for(const s of t){const i=s.match(/^([A-Z]{2,3}):\s*(.*)$/);if(!i)continue;const o=i[1];k.includes(o)&&(n[o]=(r=i[2])!=null?r:"")}return!n.SFS&&!n.MS?null:{sfName:n.SFS,sfGlyph:n.SFG,sfCategories:M(n.SFC),sfSearchTerms:M(n.SFT),materialName:n.MS,materialCategories:M(n.MSC),materialTags:M(n.MST)}}const $="variableGroupId",q="mappingState",K="ipairs",l=(...e)=>{try{console.log("[icon-pairs][plugin]",...e)}catch(t){}},m=B.channelBuilder().emitsTo(U,e=>{figma.ui.postMessage(e)}).receivesFrom(U,e=>{const t=n=>e(n);return figma.ui.on("message",t),()=>figma.ui.off("message",t)}).startListening();function de(e){var r,s,i,o,a,c,d,f;if(typeof e=="string")return{id:e,name:e};if(!e)return null;const t=(o=(i=(s=(r=e.id)!=null?r:e.groupId)!=null?s:e.key)!=null?i:e.modeId)!=null?o:typeof e.name=="string"?e.name:null,n=(f=(d=(c=(a=e.name)!=null?a:e.label)!=null?c:e.title)!=null?d:e.groupName)!=null?f:typeof e.id=="string"?e.id:null;return t?{id:String(t),name:String(n!=null?n:t)}:null}async function fe(){return(await figma.variables.getLocalVariableCollectionsAsync()).map(t=>{var s,i,o;const n=(o=(i=(s=t.variableGroups)!=null?s:t.groups)!=null?i:t.variableGroupIds)!=null?o:[],r=Array.isArray(n)?n.map(de).filter(a=>!!a):[];return{id:t.id,name:t.name,modes:t.modes.map(a=>({modeId:a.modeId,name:a.name})),defaultModeId:t.defaultModeId,groups:r}})}function E(e,t,n){const r=e.modes.map(a=>a.modeId),s=new Set(t),i=new Set(n);if(s.size===0||i.size===0)throw new Error("Assign at least one mode to SF and one to Material.");for(const a of s){if(!r.includes(a))throw new Error("Some SF modes are not part of the collection.");if(i.has(a))throw new Error("A mode cannot be assigned to both SF and Material.")}for(const a of i)if(!r.includes(a))throw new Error("Some Material modes are not part of the collection.");if(new Set([...s,...i]).size!==r.length)throw new Error("Every mode in the collection must be assigned to SF or Material.")}function b(e){var r,s;const t=(r=e.variableGroupId)!=null?r:null;return((s=e.getPluginData)==null?void 0:s.call(e,$))||t||null}function me(e,t){var r,s;if(!t)return;const n=(s=(r=e.setVariableGroupId)!=null?r:e.setGroupId)!=null?s:e.assignVariableGroup;if(typeof n=="function")try{n.call(e,t)}catch(i){console.warn("Unable to set variable group via setter",i)}else if("variableGroupId"in e)try{e.variableGroupId=t}catch(i){console.warn("Unable to assign variableGroupId directly",i)}try{e.setPluginData($,t)}catch(i){console.warn("Unable to store group id in plugin data",i)}}function P(e,t,n){var c,d,f;const r=(c=e.valuesByMode)!=null?c:{},s=t[0],i=n[0],o=s&&typeof r[s]=="string"?r[s]:null,a=i&&typeof r[i]=="string"?r[i]:null;return{id:e.id,name:e.name,collectionId:e.variableCollectionId,groupId:b(e),description:(d=e.description)!=null?d:"",descriptionFields:w((f=e.description)!=null?f:""),sfValue:o,materialValue:a}}function T(){try{const e=figma.root.getPluginData(K);if(!e)return new Map;const t=JSON.parse(e);if(!t||!Array.isArray(t.p))return new Map;const n=new Map;for(const r of t.p)Array.isArray(r)&&typeof r[0]=="string"&&typeof r[1]=="string"&&typeof r[2]=="string"&&typeof r[3]=="number"&&typeof r[4]=="number"&&n.set(r[0],{id:r[0],sf:r[1],mat:r[2],c:r[3],u:r[4]});return n}catch(e){return console.warn("Failed to parse pluginData pairs",e),new Map}}function X(e){if(!e||typeof e!="object")return"";for(const t of Object.values(e))if(typeof t=="string"&&t)return t;return""}function N(e,t){const n={v:1,p:e.map(r=>[r.id,r.sf,r.mat,r.c,r.u])};try{figma.root.setPluginData(K,JSON.stringify(n)),l("pluginData updated",{reason:t,count:e.length,payload:n})}catch(r){console.warn("Unable to store pluginData pairs",r)}}async function ge(){const e=T(),t=Date.now(),r=(await figma.variables.getLocalVariablesAsync("STRING")).map(s=>{var d,f;const i=w((d=s.description)!=null?d:"")||null,o=(i==null?void 0:i.sfName)||s.name||"",a=(i==null?void 0:i.materialName)||X(s.valuesByMode)||"",c=e.get(s.id);return{id:s.id,sf:o,mat:a,c:(f=c==null?void 0:c.c)!=null?f:t,u:t}});N(r,"snapshot")}async function Y(e){var a,c;const t=T(),n=Date.now(),r=w((a=e.description)!=null?a:"")||null,s=(r==null?void 0:r.sfName)||e.name||"",i=(r==null?void 0:r.materialName)||X(e.valuesByMode)||"",o=t.get(e.id);t.set(e.id,{id:e.id,sf:s,mat:i,c:(c=o==null?void 0:o.c)!=null?c:n,u:n}),N(Array.from(t.values()),"upsert")}async function he(e){const t=T();t.delete(e),N(Array.from(t.values()),"remove")}async function C(e){const t=await figma.variables.getVariableCollectionByIdAsync(e);if(!t)throw new Error("Collection not found.");return t}m.registerMessageHandler("ping",()=>(l("ping"),"pong"));m.registerMessageHandler("getEnvironment",async()=>{const e=figma.editorType==="dev"||figma.mode==="dev"||figma.mode==="code"||figma.isInDevMode===!0||figma.devMode===!0,n=(await figma.variables.getLocalVariableCollectionsAsync()).length>0;return l("getEnvironment",{editorType:figma.editorType,isDevMode:e}),{isDevMode:e,isLibraryFile:n}});function S(e){if(l("extractIds:raw",e),!e)return[];if(typeof e=="string")return e.startsWith("VariableID:")||e.startsWith("VariableCollectionId:")?[e]:(l("extractIds:string_ignored",e),[]);if(Array.isArray(e)){const t=e.flatMap(n=>S(n));return l("extractIds:array",t),t}if(typeof e=="object"&&e!==null){if(typeof e.id=="string")return l("extractIds:object.id",e.id),[e.id];if(typeof e.variableId=="string")return l("extractIds:object.variableId",e.variableId),[e.variableId];if(typeof e.value=="string")return l("extractIds:object.value",e.value),[e.value];l("extractIds:object.unhandledKeys",Object.keys(e))}return[]}function W(){const e=new Set,t=n=>{var r,s,i,o;if(l("visit:node",{type:n.type,name:n.name}),"children"in n)for(const a of n.children)t(a);if(n.type==="TEXT"){const a=n.boundVariables;l("text",n),l("text:boundVariables",a);const c=a==null?void 0:a.characters,d=S(c);l("text:charactersVarIds",d),d.forEach(f=>e.add(f))}if("componentProperties"in n){l("instanceNode",n);const a=(r=n.componentProperties)!=null?r:{},c=(i=(s=n.boundVariables)==null?void 0:s.componentProperties)!=null?i:{},d=(o=n.componentPropertyReferences)!=null?o:{};Object.entries(a).forEach(([f,u])=>{var G,R,_;const A=c[f],V=d[f],F=(_=(R=(G=u==null?void 0:u.boundVariables)==null?void 0:G.value)!=null?R:u==null?void 0:u.boundVariables)!=null?_:void 0;if(l("instance:componentProperty",{node:n.name,name:f,type:u==null?void 0:u.type,value:u==null?void 0:u.value,bound:A,ref:V,inlineBound:F}),(u==null?void 0:u.type)==="TEXT"||(u==null?void 0:u.type)==="STRING"||(u==null?void 0:u.type)==="TEXT_LITERAL"){const J=S(A),Z=S(u==null?void 0:u.value),Q=S(V),ee=S(F),L=[...J,...Z,...Q,...ee];l("instance:componentPropertyVarIds",{name:f,ids:L}),L.forEach(te=>e.add(te))}})}};for(const n of figma.currentPage.selection)t(n);return{pairIds:Array.from(e),selectionCount:figma.currentPage.selection.length}}function v(){const e=W();l("selectionchange",`nodes=${e.selectionCount}`,`pairIds=${e.pairIds.join(",")||"none"}`);try{figma.ui.postMessage(x({type:"selectionPairs"},e))}catch(t){console.warn("Failed to post selection pairs",t)}}function Se(){figma.on("selectionchange",v),v()}m.registerMessageHandler("getSelectionPairs",async()=>W());m.registerMessageHandler("clearSelection",async()=>{figma.currentPage.selection=[],v()});m.registerMessageHandler("notify",async e=>{l("notify",e);try{figma.notify(e,{timeout:2e3})}catch(t){console.warn("Failed to notify",t)}});m.registerMessageHandler("getCollections",async()=>(l("getCollections"),fe()));m.registerMessageHandler("loadMappingState",async()=>{var r,s,i,o;l("loadMappingState");const e=await figma.clientStorage.getAsync(q);if(!e)return{collectionId:null,groupId:null,sfModeIds:[],materialModeIds:[]};const t=e,n=a=>Array.isArray(a)?a.filter(c=>typeof c=="string"):typeof a=="string"?a?[a]:[]:[];return{collectionId:(r=t.collectionId)!=null?r:null,groupId:(s=t.groupId)!=null?s:null,sfModeIds:n((i=t.sfModeIds)!=null?i:t.sfModeId),materialModeIds:n((o=t.materialModeIds)!=null?o:t.materialModeId)}});m.registerMessageHandler("saveMappingState",async e=>{l("saveMappingState",e),await figma.clientStorage.setAsync(q,e)});m.registerMessageHandler("loadPairs",async e=>{l("loadPairs",e);const t=await C(e.collectionId);return E(t,e.sfModeIds,e.materialModeIds),(await figma.variables.getLocalVariablesAsync("STRING")).filter(s=>s.variableCollectionId!==e.collectionId?!1:e.groupId?b(s)===e.groupId:!0).map(s=>P(s,e.sfModeIds,e.materialModeIds))});m.registerMessageHandler("createPair",async e=>{var r;if(l("createPair",e),figma.editorType!=="figma")throw new Error("Variables are only supported in Figma files.");const t=await C(e.collectionId);E(t,e.sfModeIds,e.materialModeIds);const n=figma.variables.createVariable(e.sf.symbol,t,"STRING");return l("createPair variable created",n.id),me(n,(r=e.groupId)!=null?r:null),n.scopes=["TEXT_CONTENT"],e.sfModeIds.forEach(s=>n.setValueForMode(s,e.sf.symbol)),e.materialModeIds.forEach(s=>n.setValueForMode(s,e.material.name)),n.description=z(e.sf,e.material),l("createPair variable configured",{id:n.id,name:n.name}),await Y(n),P(n,e.sfModeIds,e.materialModeIds)});m.registerMessageHandler("updatePair",async e=>{var i,o;l("updatePair",e);const t=await figma.variables.getVariableByIdAsync(e.variableId);if(!t)throw new Error("Variable not found.");if(t.resolvedType!=="STRING")throw new Error("Only STRING variables can be updated.");if(t.variableCollectionId!==e.collectionId)throw new Error("Cannot move variable to a different collection.");const n=await C(e.collectionId);E(n,e.sfModeIds,e.materialModeIds);const r=b(t),s=(o=(i=e.groupId)!=null?i:r)!=null?o:null;if((s!=null?s:null)!==(r!=null?r:null))throw new Error("Group cannot be changed for an existing pair.");return t.name=e.sf.symbol,e.sfModeIds.forEach(a=>t.setValueForMode(a,e.sf.symbol)),e.materialModeIds.forEach(a=>t.setValueForMode(a,e.material.name)),t.description=z(e.sf,e.material),t.scopes=["TEXT_CONTENT"],await Y(t),P(t,e.sfModeIds,e.materialModeIds)});m.registerMessageHandler("deletePair",async e=>{l("deletePair",{variableId:e});const t=await figma.variables.getVariableByIdAsync(e);t&&(t.remove(),await he(e))});async function Ie(){g.initialize(B,m),figma.showUI(__html__,{width:320,height:660,themeColors:!0}),Se(),ge().catch(e=>console.warn("Failed to snapshot plugin data",e)),console.log("Bootstrapped @",g.getCurrentSide().name)}Ie();
