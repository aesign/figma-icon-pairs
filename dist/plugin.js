var Y=Object.defineProperty;var A=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable;var _=(e,t,r)=>t in e?Y(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,L=(e,t)=>{for(var r in t||(t={}))Z.call(t,r)&&_(e,r,t[r]);if(A)for(var r of A(t))J.call(t,r)&&_(e,r,t[r]);return e};var Q=Object.defineProperty,ee=(e,t,r)=>t in e?Q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,I=(e,t,r)=>(ee(e,typeof t!="symbol"?t+"":t,r),r),h=(e,t,r)=>new Promise((n,s)=>{var i=c=>{try{a(r.next(c))}catch(d){s(d)}},o=c=>{try{a(r.throw(c))}catch(d){s(d)}},a=c=>c.done?n(c.value):Promise.resolve(c.value).then(i,o);a((r=r.apply(e,t)).next())});class te extends Error{constructor(t){super(t.payload[0])}}function M(){const e=new Array(36);for(let t=0;t<36;t++)e[t]=Math.floor(Math.random()*16);return e[14]=4,e[19]=e[19]&=-5,e[19]=e[19]|=8,e[8]=e[13]=e[18]=e[23]="-",e.map(t=>t.toString(16)).join("")}const x="__INTERNAL_SUCCESS_RESPONSE_EVENT",H="__INTERNAL_ERROR_RESPONSE_EVENT";class re{constructor(t){I(this,"emitStrategies",new Map),I(this,"receiveStrategies",new Map),this.side=t}receivesFrom(t,r){return this.receiveStrategies.set(t.name,r),this}emitsTo(t,r){return this.emitStrategies.set(t.name,r),this}startListening(){return new ne(this.side,this.emitStrategies,this.receiveStrategies)}}class ne{constructor(t,r=new Map,n=new Map){I(this,"messageHandlers",{}),I(this,"subscriptionListeners",{}),I(this,"pendingRequests",new Map),I(this,"cleanupCallbacks",[]),this.side=t,this.emitStrategies=r,this.receiveStrategies=n,n.forEach(s=>{const i=s((o,a)=>this.receiveNetworkMessage(o,a));i&&this.cleanupCallbacks.push(i)})}registerMessageHandler(t,r){this.messageHandlers[t]=r}getEmitStrategy(t){const r=this.emitStrategies.get(t.name);if(!r){const n=m.getCurrentSide();throw new Error(`No emit strategy is registered from ${n.name} to ${t.name}`)}return r}receiveNetworkMessage(t,r){return h(this,null,function*(){if(t.eventName===x){this.receiveSuccessResponse(t);return}if(t.eventName===H){this.receiveErrorResponse(t);return}this.invokeSubscribers(t),this.handleIncomingMessage(t,r)})}receiveSuccessResponse(t){return h(this,null,function*(){var r;const{resolve:n}=(r=this.pendingRequests.get(t.messageId))!=null?r:{};n&&(this.pendingRequests.delete(t.messageId),n(t.payload[0]))})}receiveErrorResponse(t){return h(this,null,function*(){var r;const{reject:n}=(r=this.pendingRequests.get(t.messageId))!=null?r:{};n&&(this.pendingRequests.delete(t.messageId),n(new te(t)))})}invokeSubscribers(t){return h(this,null,function*(){var r;Object.values((r=this.subscriptionListeners[t.eventName])!=null?r:{}).forEach(n=>{n(...t.payload,m.getSide(t.fromSide),t)})})}handleIncomingMessage(t,r){return h(this,null,function*(){const n=this.messageHandlers[t.eventName];if(n!=null){const s=m.getSide(t.fromSide);if(!s)throw new Error(`Message received from an unknown side: ${t.fromSide}`);const i=this.getEmitStrategy(s);try{const o=yield n(...t.payload,m.getSide(t.fromSide),t);i!=null&&i({messageId:t.messageId,fromSide:t.fromSide,eventName:x,payload:[o]},r)}catch(o){i!=null&&i({messageId:t.messageId,fromSide:t.fromSide,eventName:H,payload:[o instanceof Error?o.message:"Failed to handle"]},r)}}})}emit(t,r,n,...[s]){this.getEmitStrategy(t)({messageId:M(),fromSide:m.getCurrentSide().name,eventName:r.toString(),payload:n},s)}request(t,r,n){return h(this,arguments,function*(s,i,o,...[a]){const c=this.getEmitStrategy(s),d=M();return new Promise((g,u)=>{this.pendingRequests.set(d,{resolve:g,reject:u}),c({messageId:d,fromSide:m.getCurrentSide().name,eventName:i.toString(),payload:o},a)})})}subscribe(t,r){var n,s;const i=M(),o=(s=(n=this.subscriptionListeners)[t])!=null?s:n[t]={};return o[i]=r,()=>{delete this.subscriptionListeners[t][i]}}}class se{constructor(t){this.name=t}channelBuilder(){return new re(this)}}var m;(e=>{const t=[];let r;function n(){if(r==null)throw new Error("Logical side is not initialized yet.");return r}e.getCurrentSide=n;function s(a,c){if(r!=null)throw new Error("Logical side can be declared only once.");if(c.side!==a)throw new Error("Given side and channel side doesn't match");r=a}e.initialize=s;function i(a){return{listens:()=>{const c=new se(a);return t.push(c),c}}}e.createSide=i;function o(a){for(let c of t)if(c.name===a)return c;return null}e.getSide=o})(m||(m={}));const j=m.createSide("UI-side").listens(),B=m.createSide("Plugin-side").listens(),D=["SFS","SFG","SFC","SFT","MS","MSC","MST"];function v(e){return e.filter(Boolean).join(", ")}function y(e){return e.trim()?e.split(",").map(t=>t.trim()).filter(Boolean):[]}function O(e,t){const r={SFS:e.name,SFG:e.symbol,SFC:v(e.categories),SFT:v(e.searchTerms),MS:t.name,MSC:v(t.categories),MST:v(t.tags)};return D.map(n=>{var s;return`${n}: ${(s=r[n])!=null?s:""}`}).join(`
`)}function ie(e){var n;const t=e.split(/\r?\n/),r={SFS:"",SFG:"",SFC:"",SFT:"",MS:"",MSC:"",MST:""};for(const s of t){const i=s.match(/^([A-Z]{2,3}):\s*(.*)$/);if(!i)continue;const o=i[1];D.includes(o)&&(r[o]=(n=i[2])!=null?n:"")}return!r.SFS&&!r.MS?null:{sfName:r.SFS,sfGlyph:r.SFG,sfCategories:y(r.SFC),sfSearchTerms:y(r.SFT),materialName:r.MS,materialCategories:y(r.MSC),materialTags:y(r.MST)}}const U="variableGroupId",k="mappingState",l=(...e)=>{try{console.log("[icon-pairs][plugin]",...e)}catch(t){}},f=B.channelBuilder().emitsTo(j,e=>{figma.ui.postMessage(e)}).receivesFrom(j,e=>{const t=r=>e(r);return figma.ui.on("message",t),()=>figma.ui.off("message",t)}).startListening();function ae(e){var n,s,i,o,a,c,d,g;if(typeof e=="string")return{id:e,name:e};if(!e)return null;const t=(o=(i=(s=(n=e.id)!=null?n:e.groupId)!=null?s:e.key)!=null?i:e.modeId)!=null?o:typeof e.name=="string"?e.name:null,r=(g=(d=(c=(a=e.name)!=null?a:e.label)!=null?c:e.title)!=null?d:e.groupName)!=null?g:typeof e.id=="string"?e.id:null;return t?{id:String(t),name:String(r!=null?r:t)}:null}async function oe(){return(await figma.variables.getLocalVariableCollectionsAsync()).map(t=>{var s,i,o;const r=(o=(i=(s=t.variableGroups)!=null?s:t.groups)!=null?i:t.variableGroupIds)!=null?o:[],n=Array.isArray(r)?r.map(ae).filter(a=>!!a):[];return{id:t.id,name:t.name,modes:t.modes.map(a=>({modeId:a.modeId,name:a.name})),defaultModeId:t.defaultModeId,groups:n}})}function E(e,t,r){const n=new Set(e.modes.map(s=>s.modeId));if(!n.has(t)||!n.has(r))throw new Error("Selected modes do not belong to the collection.");if(t===r)throw new Error("SF and Material modes must be different.")}function w(e){var n,s;const t=(n=e.variableGroupId)!=null?n:null;return((s=e.getPluginData)==null?void 0:s.call(e,U))||t||null}function ce(e,t){var n,s;if(!t)return;const r=(s=(n=e.setVariableGroupId)!=null?n:e.setGroupId)!=null?s:e.assignVariableGroup;if(typeof r=="function")try{r.call(e,t)}catch(i){console.warn("Unable to set variable group via setter",i)}else if("variableGroupId"in e)try{e.variableGroupId=t}catch(i){console.warn("Unable to assign variableGroupId directly",i)}try{e.setPluginData(U,t)}catch(i){console.warn("Unable to store group id in plugin data",i)}}function T(e,t,r){var o,a,c;const n=(o=e.valuesByMode)!=null?o:{},s=typeof n[t]=="string"?n[t]:null,i=typeof n[r]=="string"?n[r]:null;return{id:e.id,name:e.name,collectionId:e.variableCollectionId,groupId:w(e),description:(a=e.description)!=null?a:"",descriptionFields:ie((c=e.description)!=null?c:""),sfValue:s,materialValue:i}}async function p(e){const t=await figma.variables.getVariableCollectionByIdAsync(e);if(!t)throw new Error("Collection not found.");return t}f.registerMessageHandler("ping",()=>(l("ping"),"pong"));f.registerMessageHandler("getEnvironment",async()=>{const e=figma.editorType==="dev"||figma.mode==="dev"||figma.mode==="code"||figma.isInDevMode===!0||figma.devMode===!0,r=(await figma.variables.getLocalVariableCollectionsAsync()).length>0;return l("getEnvironment",{editorType:figma.editorType,isDevMode:e}),{isDevMode:e,isLibraryFile:r}});function S(e){if(l("extractIds:raw",e),!e)return[];if(typeof e=="string")return e.startsWith("VariableID:")||e.startsWith("VariableCollectionId:")?[e]:(l("extractIds:string_ignored",e),[]);if(Array.isArray(e)){const t=e.flatMap(r=>S(r));return l("extractIds:array",t),t}if(typeof e=="object"&&e!==null){if(typeof e.id=="string")return l("extractIds:object.id",e.id),[e.id];if(typeof e.variableId=="string")return l("extractIds:object.variableId",e.variableId),[e.variableId];if(typeof e.value=="string")return l("extractIds:object.value",e.value),[e.value];l("extractIds:object.unhandledKeys",Object.keys(e))}return[]}function $(){const e=new Set,t=r=>{var n,s,i,o;if(l("visit:node",{type:r.type,name:r.name}),"children"in r)for(const a of r.children)t(a);if(r.type==="TEXT"){const a=r.boundVariables;l("text",r),l("text:boundVariables",a);const c=a==null?void 0:a.characters,d=S(c);l("text:charactersVarIds",d),d.forEach(g=>e.add(g))}if("componentProperties"in r){l("instanceNode",r);const a=(n=r.componentProperties)!=null?n:{},c=(i=(s=r.boundVariables)==null?void 0:s.componentProperties)!=null?i:{},d=(o=r.componentPropertyReferences)!=null?o:{};Object.entries(a).forEach(([g,u])=>{var V,F,R;const P=c[g],C=d[g],N=(R=(F=(V=u==null?void 0:u.boundVariables)==null?void 0:V.value)!=null?F:u==null?void 0:u.boundVariables)!=null?R:void 0;if(l("instance:componentProperty",{node:r.name,name:g,type:u==null?void 0:u.type,value:u==null?void 0:u.value,bound:P,ref:C,inlineBound:N}),(u==null?void 0:u.type)==="TEXT"||(u==null?void 0:u.type)==="STRING"||(u==null?void 0:u.type)==="TEXT_LITERAL"){const q=S(P),z=S(u==null?void 0:u.value),X=S(C),K=S(N),G=[...q,...z,...X,...K];l("instance:componentPropertyVarIds",{name:g,ids:G}),G.forEach(W=>e.add(W))}})}};for(const r of figma.currentPage.selection)t(r);return{pairIds:Array.from(e),selectionCount:figma.currentPage.selection.length}}function b(){const e=$();l("selectionchange",`nodes=${e.selectionCount}`,`pairIds=${e.pairIds.join(",")||"none"}`);try{figma.ui.postMessage(L({type:"selectionPairs"},e))}catch(t){console.warn("Failed to post selection pairs",t)}}function le(){figma.on("selectionchange",b),b()}f.registerMessageHandler("getSelectionPairs",async()=>$());f.registerMessageHandler("clearSelection",async()=>{figma.currentPage.selection=[],b()});f.registerMessageHandler("notify",async e=>{l("notify",e);try{figma.notify(e,{timeout:2e3})}catch(t){console.warn("Failed to notify",t)}});f.registerMessageHandler("getCollections",async()=>(l("getCollections"),oe()));f.registerMessageHandler("loadMappingState",async()=>{l("loadMappingState");const e=await figma.clientStorage.getAsync(k);return e||{collectionId:null,groupId:null,sfModeId:null,materialModeId:null}});f.registerMessageHandler("saveMappingState",async e=>{l("saveMappingState",e),await figma.clientStorage.setAsync(k,e)});f.registerMessageHandler("loadPairs",async e=>{l("loadPairs",e);const t=await p(e.collectionId);return E(t,e.sfModeId,e.materialModeId),(await figma.variables.getLocalVariablesAsync("STRING")).filter(s=>s.variableCollectionId!==e.collectionId?!1:e.groupId?w(s)===e.groupId:!0).map(s=>T(s,e.sfModeId,e.materialModeId))});f.registerMessageHandler("createPair",async e=>{var n;if(l("createPair",e),figma.editorType!=="figma")throw new Error("Variables are only supported in Figma files.");const t=await p(e.collectionId);E(t,e.sfModeId,e.materialModeId);const r=figma.variables.createVariable(e.sf.symbol,t,"STRING");return l("createPair variable created",r.id),ce(r,(n=e.groupId)!=null?n:null),r.scopes=["TEXT_CONTENT"],r.setValueForMode(e.sfModeId,e.sf.symbol),r.setValueForMode(e.materialModeId,e.material.name),r.description=O(e.sf,e.material),l("createPair variable configured",{id:r.id,name:r.name}),T(r,e.sfModeId,e.materialModeId)});f.registerMessageHandler("updatePair",async e=>{var i,o;l("updatePair",e);const t=await figma.variables.getVariableByIdAsync(e.variableId);if(!t)throw new Error("Variable not found.");if(t.resolvedType!=="STRING")throw new Error("Only STRING variables can be updated.");if(t.variableCollectionId!==e.collectionId)throw new Error("Cannot move variable to a different collection.");const r=await p(e.collectionId);E(r,e.sfModeId,e.materialModeId);const n=w(t),s=(o=(i=e.groupId)!=null?i:n)!=null?o:null;if((s!=null?s:null)!==(n!=null?n:null))throw new Error("Group cannot be changed for an existing pair.");return t.name=e.sf.symbol,t.setValueForMode(e.sfModeId,e.sf.symbol),t.setValueForMode(e.materialModeId,e.material.name),t.description=O(e.sf,e.material),t.scopes=["TEXT_CONTENT"],T(t,e.sfModeId,e.materialModeId)});f.registerMessageHandler("deletePair",async e=>{l("deletePair",{variableId:e});const t=await figma.variables.getVariableByIdAsync(e);t&&t.remove()});async function ue(){m.initialize(B,f),figma.showUI(__html__,{width:320,height:660,themeColors:!0}),le(),console.log("Bootstrapped @",m.getCurrentSide().name)}ue();
