var ue=Object.defineProperty;var j=Object.getOwnPropertySymbols;var fe=Object.prototype.hasOwnProperty,de=Object.prototype.propertyIsEnumerable;var k=(e,t,r)=>t in e?ue(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,B=(e,t)=>{for(var r in t||(t={}))fe.call(t,r)&&k(e,r,t[r]);if(j)for(var r of j(t))de.call(t,r)&&k(e,r,t[r]);return e};var me=Object.defineProperty,ge=(e,t,r)=>t in e?me(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,b=(e,t,r)=>(ge(e,typeof t!="symbol"?t+"":t,r),r),S=(e,t,r)=>new Promise((n,i)=>{var s=l=>{try{o(r.next(l))}catch(f){i(f)}},a=l=>{try{o(r.throw(l))}catch(f){i(f)}},o=l=>l.done?n(l.value):Promise.resolve(l.value).then(s,a);o((r=r.apply(e,t)).next())});class ye extends Error{constructor(t){super(t.payload[0])}}function N(){const e=new Array(36);for(let t=0;t<36;t++)e[t]=Math.floor(Math.random()*16);return e[14]=4,e[19]=e[19]&=-5,e[19]=e[19]|=8,e[8]=e[13]=e[18]=e[23]="-",e.map(t=>t.toString(16)).join("")}const U="__INTERNAL_SUCCESS_RESPONSE_EVENT",$="__INTERNAL_ERROR_RESPONSE_EVENT";class he{constructor(t){b(this,"emitStrategies",new Map),b(this,"receiveStrategies",new Map),this.side=t}receivesFrom(t,r){return this.receiveStrategies.set(t.name,r),this}emitsTo(t,r){return this.emitStrategies.set(t.name,r),this}startListening(){return new Se(this.side,this.emitStrategies,this.receiveStrategies)}}class Se{constructor(t,r=new Map,n=new Map){b(this,"messageHandlers",{}),b(this,"subscriptionListeners",{}),b(this,"pendingRequests",new Map),b(this,"cleanupCallbacks",[]),this.side=t,this.emitStrategies=r,this.receiveStrategies=n,n.forEach(i=>{const s=i((a,o)=>this.receiveNetworkMessage(a,o));s&&this.cleanupCallbacks.push(s)})}registerMessageHandler(t,r){this.messageHandlers[t]=r}getEmitStrategy(t){const r=this.emitStrategies.get(t.name);if(!r){const n=g.getCurrentSide();throw new Error(`No emit strategy is registered from ${n.name} to ${t.name}`)}return r}receiveNetworkMessage(t,r){return S(this,null,function*(){if(t.eventName===U){this.receiveSuccessResponse(t);return}if(t.eventName===$){this.receiveErrorResponse(t);return}this.invokeSubscribers(t),this.handleIncomingMessage(t,r)})}receiveSuccessResponse(t){return S(this,null,function*(){var r;const{resolve:n}=(r=this.pendingRequests.get(t.messageId))!=null?r:{};n&&(this.pendingRequests.delete(t.messageId),n(t.payload[0]))})}receiveErrorResponse(t){return S(this,null,function*(){var r;const{reject:n}=(r=this.pendingRequests.get(t.messageId))!=null?r:{};n&&(this.pendingRequests.delete(t.messageId),n(new ye(t)))})}invokeSubscribers(t){return S(this,null,function*(){var r;Object.values((r=this.subscriptionListeners[t.eventName])!=null?r:{}).forEach(n=>{n(...t.payload,g.getSide(t.fromSide),t)})})}handleIncomingMessage(t,r){return S(this,null,function*(){const n=this.messageHandlers[t.eventName];if(n!=null){const i=g.getSide(t.fromSide);if(!i)throw new Error(`Message received from an unknown side: ${t.fromSide}`);const s=this.getEmitStrategy(i);try{const a=yield n(...t.payload,g.getSide(t.fromSide),t);s!=null&&s({messageId:t.messageId,fromSide:t.fromSide,eventName:U,payload:[a]},r)}catch(a){s!=null&&s({messageId:t.messageId,fromSide:t.fromSide,eventName:$,payload:[a instanceof Error?a.message:"Failed to handle"]},r)}}})}emit(t,r,n,...[i]){this.getEmitStrategy(t)({messageId:N(),fromSide:g.getCurrentSide().name,eventName:r.toString(),payload:n},i)}request(t,r,n){return S(this,arguments,function*(i,s,a,...[o]){const l=this.getEmitStrategy(i),f=N();return new Promise((d,c)=>{this.pendingRequests.set(f,{resolve:d,reject:c}),l({messageId:f,fromSide:g.getCurrentSide().name,eventName:s.toString(),payload:a},o)})})}subscribe(t,r){var n,i;const s=N(),a=(i=(n=this.subscriptionListeners)[t])!=null?i:n[t]={};return a[s]=r,()=>{delete this.subscriptionListeners[t][s]}}}class Ie{constructor(t){this.name=t}channelBuilder(){return new he(this)}}var g;(e=>{const t=[];let r;function n(){if(r==null)throw new Error("Logical side is not initialized yet.");return r}e.getCurrentSide=n;function i(o,l){if(r!=null)throw new Error("Logical side can be declared only once.");if(l.side!==o)throw new Error("Given side and channel side doesn't match");r=o}e.initialize=i;function s(o){return{listens:()=>{const l=new Ie(o);return t.push(l),l}}}e.createSide=s;function a(o){for(let l of t)if(l.name===o)return l;return null}e.getSide=a})(g||(g={}));const K=g.createSide("UI-side").listens(),W=g.createSide("Plugin-side").listens(),be=["SFS","SFG","SFC","SFT","MS","MSC","MST"];function w(e){return e.trim()?e.split(",").map(t=>t.trim()).filter(Boolean):[]}function T(e){var n;const t=e.split(/\r?\n/),r={SFS:"",SFG:"",SFC:"",SFT:"",MS:"",MSC:"",MST:""};for(const i of t){const s=i.match(/^([A-Z]{2,3}):\s*(.*)$/);if(!s)continue;const a=s[1];be.includes(a)&&(r[a]=(n=s[2])!=null?n:"")}return!r.SFS&&!r.MS?null:{sfName:r.SFS,sfGlyph:r.SFG,sfCategories:w(r.SFC),sfSearchTerms:w(r.SFT),materialName:r.MS,materialCategories:w(r.MSC),materialTags:w(r.MST)}}const Y="variableGroupId",X="ipairs",J="ipairsSourceSettings",A="bfa1827c219b14613541995a265ff542ea795e05";let z=!1;const u=(...e)=>{try{console.log("[icon-pairs][plugin]",...e)}catch(t){}},m=W.channelBuilder().emitsTo(K,e=>{figma.ui.postMessage(e)}).receivesFrom(K,e=>{const t=r=>e(r);return figma.ui.on("message",t),()=>figma.ui.off("message",t)}).startListening();function pe(e){var n,i,s,a,o,l,f,d;if(typeof e=="string")return{id:e,name:e};if(!e)return null;const t=(a=(s=(i=(n=e.id)!=null?n:e.groupId)!=null?i:e.key)!=null?s:e.modeId)!=null?a:typeof e.name=="string"?e.name:null,r=(d=(f=(l=(o=e.name)!=null?o:e.label)!=null?l:e.title)!=null?f:e.groupName)!=null?d:typeof e.id=="string"?e.id:null;return t?{id:String(t),name:String(r!=null?r:t)}:null}async function ve(){const e=await figma.variables.getLocalVariableCollectionsAsync(),t=await figma.variables.getLocalVariablesAsync("STRING");return e.map(r=>{var l,f,d;const n=t.filter(c=>c.variableCollectionId===r.id),i=(d=(f=(l=r.variableGroups)!=null?l:r.groups)!=null?f:r.variableGroupIds)!=null?d:[],s=Array.isArray(i)?i.map(pe).filter(c=>!!c):[],a=new Map;for(const c of n){const p=(c.name||"").split("/").filter(Boolean);for(let h=1;h<p.length;h++){const v=p.slice(0,h).join("/");a.has(v)||a.set(v,{id:v,name:v})}}const o=new Map;for(const c of s)o.set(c.id,c);for(const c of a.values())o.set(c.id,c);return{id:r.id,name:r.name,modes:r.modes.map(c=>({modeId:c.modeId,name:c.name})),defaultModeId:r.defaultModeId,groups:Array.from(o.values())}})}function y(e){return figma.editorType!=="figma"||Z()?!1:e>0}function Z(){return figma.editorType==="dev"||figma.mode==="dev"||figma.mode==="code"||figma.isInDevMode===!0||figma.devMode===!0}async function we(){const e=await figma.variables.getLocalVariableCollectionsAsync();return y(e.length)}async function Q(){const e=figma.teamLibrary;return e!=null&&e.getAvailableLibraryVariableCollectionsAsync?(await e.getAvailableLibraryVariableCollectionsAsync()).map(r=>{var n,i,s,a;return{key:String(r.key),name:String((n=r.name)!=null?n:r.key),libraryName:String((a=(s=(i=r.libraryName)!=null?i:r.library)!=null?s:r.publisherName)!=null?a:"Library")}}):[]}async function Me(){var e,t,r,n,i;if(!z){z=!0;try{const s=await Q(),a=(e=s.find(o=>o.key===A))!=null?e:null;u("readOnlyStartupSelection",{persistedLibraryCollectionKey:null,hardcodedLibraryCollectionKey:A,matchedCollectionKey:(t=a==null?void 0:a.key)!=null?t:null,matchedCollectionName:(r=a==null?void 0:a.name)!=null?r:null,matchedLibraryName:(n=a==null?void 0:a.libraryName)!=null?n:null,availableLibraryCollectionCount:s.length})}catch(s){u("readOnlyStartupSelection:error",String((i=s==null?void 0:s.message)!=null?i:s))}}}function L(e,t,r){const n=e.modes.map(o=>o.modeId),i=new Set(t),s=new Set(r);if(i.size===0||s.size===0)throw new Error("Assign at least one mode to SF and one to Material.");for(const o of i){if(!n.includes(o))throw new Error("Some SF modes are not part of the collection.");if(s.has(o))throw new Error("A mode cannot be assigned to both SF and Material.")}for(const o of s)if(!n.includes(o))throw new Error("Some Material modes are not part of the collection.");if(new Set([...i,...s]).size!==n.length)throw new Error("Every mode in the collection must be assigned to SF or Material.")}function V(e){var n,i;const t=(n=e.variableGroupId)!=null?n:null;return((i=e.getPluginData)==null?void 0:i.call(e,Y))||t||null}function ee(e,t){var n,i;if(!t)return;const r=(i=(n=e.setVariableGroupId)!=null?n:e.setGroupId)!=null?i:e.assignVariableGroup;if(typeof r=="function")try{r.call(e,t)}catch(s){console.warn("Unable to set variable group via setter",s)}else if("variableGroupId"in e)try{e.variableGroupId=t}catch(s){console.warn("Unable to assign variableGroupId directly",s)}try{e.setPluginData(Y,t)}catch(s){console.warn("Unable to store group id in plugin data",s)}}function Ee(e,t){if(!e||!t)return!1;const r=e.split("/").filter(Boolean);for(let n=1;n<r.length;n++)if(r.slice(0,n).join("/")===t)return!0;return!1}function Ce(e){return e.trim().toLowerCase().replace(/\s+/g," ")}function q(e){return e.split(/[._/\-\s]+/).map(t=>t.trim()).filter(Boolean)}function te(e,t){const r=new Set,n=[...e.searchTerms,...e.categories,...q(e.name),...t.tags,...t.categories,...q(t.name)];for(const i of n){const s=Ce(String(i!=null?i:""));s&&r.add(s)}return Array.from(r).join(", ")}function Ne(e){return e.replace(/\./g," ").replace(/\s+/g," ").trim()}function M(e,t,r){return`${e} ${Ne(t)}__${r.trim()}`}function E(e){const t=e||"",r=t.split("/").filter(Boolean).pop()||t,n=r.indexOf("__");if(n<0)return null;const i=r.slice(0,n).trim(),s=r.slice(n+2).trim();if(!i||!s)return null;const a=Array.from(i),o=a[0]||"",l=a.slice(1).join("").trim();return!o||!l?null:{sfName:l,sfGlyph:o,sfCategories:[],sfSearchTerms:[],materialName:s,materialCategories:[],materialTags:[]}}function G(e,t,r){var d,c;const n=(d=e.valuesByMode)!=null?d:{},i=t[0],s=r[0],a=i&&typeof n[i]=="string"?n[i]:null,o=s&&typeof n[s]=="string"?n[s]:null,l=(c=e.description)!=null?c:"",f=E(e.name||"")||T(l)||null;return{id:e.id,name:e.name,collectionId:e.variableCollectionId,groupId:V(e),description:l,descriptionFields:f,sfValue:a,materialValue:o}}function R(){try{const e=figma.root.getPluginData(X);if(!e)return new Map;const t=JSON.parse(e);if(!t||!Array.isArray(t.p))return new Map;const r=new Map;for(const n of t.p)Array.isArray(n)&&typeof n[0]=="string"&&typeof n[1]=="string"&&typeof n[2]=="string"&&typeof n[3]=="number"&&typeof n[4]=="number"&&r.set(n[0],{id:n[0],sf:n[1],mat:n[2],c:n[3],u:n[4]});return r}catch(e){return console.warn("Failed to parse pluginData pairs",e),new Map}}function re(e){if(!e||typeof e!="object")return"";for(const t of Object.values(e))if(typeof t=="string"&&t)return t;return""}function _(e,t){const r={v:1,p:e.map(n=>[n.id,n.sf,n.mat,n.c,n.u])};try{figma.root.setPluginData(X,JSON.stringify(r)),u("pluginData updated",{reason:t,count:e.length,payload:r})}catch(n){console.warn("Unable to store pluginData pairs",n)}}function Ae(e){try{if(!e)return null;const t=JSON.parse(e);if(!t||typeof t!="object")return null;const r=typeof t.collectionId=="string"?t.collectionId:null,n=Array.isArray(t.sfModeIds)?t.sfModeIds.filter(s=>typeof s=="string"):[],i=Array.isArray(t.materialModeIds)?t.materialModeIds.filter(s=>typeof s=="string"):[];return{collectionId:r,sfModeIds:n,materialModeIds:i}}catch(t){return null}}async function Pe(){const e=R(),t=Date.now(),n=(await figma.variables.getLocalVariablesAsync("STRING")).map(i=>{var f,d;const s=E(i.name||"")||T((f=i.description)!=null?f:"")||null,a=(s==null?void 0:s.sfName)||i.name||"",o=(s==null?void 0:s.materialName)||re(i.valuesByMode)||"",l=e.get(i.id);return{id:i.id,sf:a,mat:o,c:(d=l==null?void 0:l.c)!=null?d:t,u:t}});_(n,"snapshot")}async function ne(e){var o,l;const t=R(),r=Date.now(),n=E(e.name||"")||T((o=e.description)!=null?o:"")||null,i=(n==null?void 0:n.sfName)||e.name||"",s=(n==null?void 0:n.materialName)||re(e.valuesByMode)||"",a=t.get(e.id);t.set(e.id,{id:e.id,sf:i,mat:s,c:(l=a==null?void 0:a.c)!=null?l:r,u:r}),_(Array.from(t.values()),"upsert")}async function Te(e){const t=R();t.delete(e.id),_(Array.from(t.values()),"remove")}async function D(e){const t=await figma.variables.getVariableCollectionByIdAsync(e);if(!t)throw new Error("Collection not found.");return t}m.registerMessageHandler("ping",()=>(u("ping"),"pong"));m.registerMessageHandler("getEnvironment",async()=>{const e=Z(),t=await figma.variables.getLocalVariableCollectionsAsync(),r=y(t.length);return(e||!r)&&await Me(),u("getEnvironment",{editorType:figma.editorType,isDevMode:e,canWrite:r}),{isDevMode:e,canWrite:r}});m.registerMessageHandler("getLibraryCollections",async()=>(u("getLibraryCollections"),Q()));function I(e){if(u("extractIds:raw",e),!e)return[];if(typeof e=="string")return e.startsWith("VariableID:")||e.startsWith("VariableCollectionId:")?[e]:(u("extractIds:string_ignored",e),[]);if(Array.isArray(e)){const t=e.flatMap(r=>I(r));return u("extractIds:array",t),t}if(typeof e=="object"&&e!==null){if(typeof e.id=="string")return u("extractIds:object.id",e.id),[e.id];if(typeof e.variableId=="string")return u("extractIds:object.variableId",e.variableId),[e.variableId];if(typeof e.value=="string")return u("extractIds:object.value",e.value),[e.value];u("extractIds:object.unhandledKeys",Object.keys(e))}return[]}function se(){const e=new Set,t=r=>{var n,i,s,a;if(u("visit:node",{type:r.type,name:r.name}),"children"in r)for(const o of r.children)t(o);if(r.type==="TEXT"){const o=r.boundVariables;u("text",r),u("text:boundVariables",o);const l=o==null?void 0:o.characters,f=I(l);u("text:charactersVarIds",f),f.forEach(d=>e.add(d))}if("componentProperties"in r){u("instanceNode",r);const o=(n=r.componentProperties)!=null?n:{},l=(s=(i=r.boundVariables)==null?void 0:i.componentProperties)!=null?s:{},f=(a=r.componentPropertyReferences)!=null?a:{};Object.entries(o).forEach(([d,c])=>{var F,O,x;const C=l[d],p=f[d],h=(x=(O=(F=c==null?void 0:c.boundVariables)==null?void 0:F.value)!=null?O:c==null?void 0:c.boundVariables)!=null?x:void 0;if(u("instance:componentProperty",{node:r.name,name:d,type:c==null?void 0:c.type,value:c==null?void 0:c.value,bound:C,ref:p,inlineBound:h}),(c==null?void 0:c.type)==="TEXT"||(c==null?void 0:c.type)==="STRING"||(c==null?void 0:c.type)==="TEXT_LITERAL"){const ie=I(C),ae=I(c==null?void 0:c.value),oe=I(p),le=I(h),H=[...ie,...ae,...oe,...le];u("instance:componentPropertyVarIds",{name:d,ids:H}),H.forEach(ce=>e.add(ce))}})}};for(const r of figma.currentPage.selection)t(r);return{pairIds:Array.from(e),selectionCount:figma.currentPage.selection.length}}function P(){const e=se();u("selectionchange",`nodes=${e.selectionCount}`,`pairIds=${e.pairIds.join(",")||"none"}`);try{figma.ui.postMessage(B({type:"selectionPairs"},e))}catch(t){console.warn("Failed to post selection pairs",t)}}function Le(){figma.on("selectionchange",P),P()}m.registerMessageHandler("getSelectionPairs",async()=>se());m.registerMessageHandler("clearSelection",async()=>{figma.currentPage.selection=[],P()});m.registerMessageHandler("notify",async e=>{u("notify",e);try{figma.notify(e,{timeout:2e3})}catch(t){console.warn("Failed to notify",t)}});m.registerMessageHandler("getCollections",async()=>(u("getCollections"),ve()));m.registerMessageHandler("loadSourceModeSettings",async()=>{const e=await figma.variables.getLocalVariableCollectionsAsync();return y(e.length)?Ae(figma.root.getPluginData(J)):null});m.registerMessageHandler("saveSourceModeSettings",async e=>{var n;const t=await figma.variables.getLocalVariableCollectionsAsync();if(!y(t.length))return;const r={collectionId:(n=e==null?void 0:e.collectionId)!=null?n:null,sfModeIds:Array.isArray(e==null?void 0:e.sfModeIds)?e.sfModeIds.filter(i=>typeof i=="string"):[],materialModeIds:Array.isArray(e==null?void 0:e.materialModeIds)?e.materialModeIds.filter(i=>typeof i=="string"):[]};figma.root.setPluginData(J,JSON.stringify(r))});m.registerMessageHandler("loadPairs",async e=>{u("loadPairs",e);const t=await D(e.collectionId);return L(t,e.sfModeIds,e.materialModeIds),(await figma.variables.getLocalVariablesAsync("STRING")).filter(i=>i.variableCollectionId!==e.collectionId?!1:e.groupId?V(i)===e.groupId?!0:Ee(i.name||"",e.groupId):!0).map(i=>G(i,e.sfModeIds,e.materialModeIds))});m.registerMessageHandler("loadLibraryPairs",async e=>{var a,o;const t=A;u("loadLibraryPairs",{requestedLibraryCollectionKey:e.libraryCollectionKey,effectiveLibraryCollectionKey:t});const r=figma.teamLibrary;if(!(r!=null&&r.getVariablesInLibraryCollectionAsync))throw new Error("Team library API is not available in this file.");const n=await r.getVariablesInLibraryCollectionAsync(t),i=(Array.isArray(n)?n:[]).filter(l=>(l==null?void 0:l.resolvedType)==="STRING");u("loadLibraryPairs:stringDescriptorCount",i.length),u("loadLibraryPairs:stringDescriptorNames",i.map(l=>{var f;return String((f=l.name)!=null?f:"")}));const s=[];for(const l of i){const f=String((a=l.name)!=null?a:""),d=E(f);if(!d)continue;const c=String((o=l.key)!=null?o:"");s.push({id:c?`LibraryVariable:${c}`:f,name:f,collectionId:t,groupId:null,description:"",descriptionFields:d,sfValue:d.sfGlyph||null,materialValue:d.materialName||null})}return u("loadLibraryPairs:parsedPairCount",s.length),s});m.registerMessageHandler("createPair",async e=>{var i;u("createPair",e);const t=await figma.variables.getLocalVariableCollectionsAsync();if(!y(t.length))throw new Error("This file is read-only. Open the source variable file to edit pairs.");const r=await D(e.collectionId);L(r,e.sfModeIds,e.materialModeIds);const n=figma.variables.createVariable(e.groupId?`${e.groupId}/${M(e.sf.symbol,e.sf.name,e.material.name)}`:M(e.sf.symbol,e.sf.name,e.material.name),r,"STRING");return u("createPair variable created",n.id),ee(n,(i=e.groupId)!=null?i:null),n.scopes=["TEXT_CONTENT"],e.sfModeIds.forEach(s=>n.setValueForMode(s,e.sf.symbol)),e.materialModeIds.forEach(s=>n.setValueForMode(s,e.material.name)),n.description=te(e.sf,e.material),u("createPair variable configured",{id:n.id,name:n.name}),await ne(n),G(n,e.sfModeIds,e.materialModeIds)});m.registerMessageHandler("updatePair",async e=>{var a,o;u("updatePair",e);const t=await figma.variables.getLocalVariableCollectionsAsync();if(!y(t.length))throw new Error("This file is read-only. Open the source variable file to edit pairs.");const r=await figma.variables.getVariableByIdAsync(e.variableId);if(!r)throw new Error("Variable not found.");if(r.resolvedType!=="STRING")throw new Error("Only STRING variables can be updated.");if(r.variableCollectionId!==e.collectionId)throw new Error("Cannot move variable to a different collection.");const n=await D(e.collectionId);L(n,e.sfModeIds,e.materialModeIds);const i=V(r),s=(o=(a=e.groupId)!=null?a:i)!=null?o:null;if((s!=null?s:null)!==(i!=null?i:null))throw new Error("Group cannot be changed for an existing pair.");return ee(r,s),r.name=s?`${s}/${M(e.sf.symbol,e.sf.name,e.material.name)}`:M(e.sf.symbol,e.sf.name,e.material.name),e.sfModeIds.forEach(l=>r.setValueForMode(l,e.sf.symbol)),e.materialModeIds.forEach(l=>r.setValueForMode(l,e.material.name)),r.description=te(e.sf,e.material),r.scopes=["TEXT_CONTENT"],await ne(r),G(r,e.sfModeIds,e.materialModeIds)});m.registerMessageHandler("deletePair",async e=>{u("deletePair",{variableId:e});const t=await figma.variables.getLocalVariableCollectionsAsync();if(!y(t.length))throw new Error("This file is read-only. Open the source variable file to edit pairs.");const r=await figma.variables.getVariableByIdAsync(e);r&&(r.remove(),await Te(r))});async function Ve(){g.initialize(W,m),figma.showUI(__html__,{width:320,height:660,themeColors:!0}),Le(),await we()&&Pe().catch(e=>console.warn("Failed to snapshot plugin data",e)),console.log("Bootstrapped @",g.getCurrentSide().name)}Ve();
